var SHEET_ID = "1fdyPrik_11VS-m1o2AaxZn_51wmfR6tm1ljuMdg32qQ";
var FOLDER_PARENT_ID = "1MTPJleij5rPJNgUEMUDpc_ahzQic-8Un";

function doGet(e) {
  var output = ContentService.createTextOutput(JSON.stringify({status: "success", message: "Please use POST to submit data."}));
  try {
    output.setMimeType(ContentService.MimeType.JSON);
    output.setHeader('Access-Control-Allow-Origin', '*');
    output.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
    output.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  } catch (e) {
    Logger.log("Error setting headers in doGet: " + e.message);
  }
  return output;
}

function doOptions(e) {
  var output = ContentService.createTextOutput('');
  try {
    output.setMimeType(ContentService.MimeType.TEXT);
    output.setHeader('Access-Control-Allow-Origin', '*');
    output.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
    output.setHeader('Access-Control-Allow-Headers', 'Content-Type');
    output.setHeader('Access-Control-Max-Age', '3600');
  } catch (e) {
    Logger.log("Error setting headers in doOptions: " + e.message);
  }
  return output;
}

function doPost(e) {
  try {
    Logger.log("========================================");
    Logger.log("doPost called at: " + new Date().toISOString());
    Logger.log("e.postData: " + (e.postData ? "exists" : "null"));
    Logger.log("e.postData.type: " + (e.postData ? e.postData.type : "N/A"));
    Logger.log("e.postData.length: " + (e.postData && e.postData.contents ? e.postData.contents.length : "N/A"));
    
    if (!e.postData || !e.postData.contents) {
      Logger.log("ERROR: No postData or contents");
      Logger.log("e object keys: " + Object.keys(e || {}).join(", "));
      return jsonResponse({ 
        error: "No se recibieron datos del formulario. El formulario está vacío o no se envió correctamente.", 
        errorType: "NO_DATA",
        status: "ERROR",
        debug: "e.postData: " + (e.postData ? "exists" : "null") + ", e.postData.contents: " + (e.postData && e.postData.contents ? "exists" : "null")
      });
    }

    Logger.log("Parsing multipart data...");
    Logger.log("Content type: " + e.postData.type);
    var data;
    try {
      data = Utilities.parseMultipart(e.postData.contents, e.postData.type);
      Logger.log("Multipart parsed successfully");
      Logger.log("Fields count: " + Object.keys(data.fields || {}).length);
      Logger.log("Fields: " + Object.keys(data.fields || {}).join(", "));
      Logger.log("Files count: " + Object.keys(data.files || {}).length);
      Logger.log("Files: " + Object.keys(data.files || {}).join(", "));
      
      // Log valores de algunos campos clave para debugging
      if (data.fields) {
        Logger.log("Email: " + (data.fields.email || "NOT SET"));
        Logger.log("Razon Social: " + (data.fields.razonSocial || "NOT SET"));
        Logger.log("Proyectos field exists: " + (data.fields.proyectos ? "YES" : "NO"));
      }
    } catch (parseErr) {
      Logger.log("ERROR parsing multipart: " + parseErr.message);
      Logger.log("Parse error stack: " + (parseErr.stack || "No stack"));
      Logger.log("Content type received: " + (e.postData ? e.postData.type : "N/A"));
      return jsonResponse({ 
        error: "Error al procesar los datos del formulario: " + parseErr.message,
        errorDetails: "Tipo de contenido: " + (e.postData ? e.postData.type : "N/A") + "\n" + (parseErr.stack || "No hay más detalles disponibles"),
        errorType: "PARSE_ERROR",
        status: "ERROR"
      });
    }

    if (!data || !data.fields) {
      Logger.log("ERROR: No fields in parsed data");
      Logger.log("Data object: " + (data ? "exists but no fields" : "null"));
      Logger.log("Data keys: " + (data ? Object.keys(data).join(", ") : "null"));
      return jsonResponse({ 
        error: "No se encontraron campos en los datos del formulario. Los datos pueden estar en un formato incorrecto.",
        errorDetails: "Objeto data: " + (data ? "existe pero sin campos 'fields'" : "null") + "\nClaves disponibles: " + (data ? Object.keys(data).join(", ") : "ninguna"),
        errorType: "NO_FIELDS",
        status: "ERROR"
      });
    }

    Logger.log("Validating required fields...");
    try {
    validateRequired(data.fields, [
      "email", "razonSocial", "nit", "domicilio", "representante", "cedulaRep",
      "direccionNotificacion", "telefono", "garantiaMonto", "instrumentoTipo",
      "entidadEmisora", "instrumentoNumero", "fechaExpedicion", "vigenciaInstrumento",
      "acepta", "firmaNombre", "firmaFecha", "proyectos"
    ]);
      Logger.log("Validation passed");
    } catch (validationErr) {
      Logger.log("Validation error: " + validationErr.message);
      Logger.log("Available fields: " + Object.keys(data.fields || {}).join(", "));
      return jsonResponse({ 
        error: validationErr.message,
        errorDetails: "Campos recibidos: " + Object.keys(data.fields || {}).join(", "),
        errorType: "VALIDATION_ERROR",
        status: "ERROR"
      });
    }

    Logger.log("Parsing proyectos...");
    var proyectos = [];
    try {
      if (data.fields.proyectos) {
      proyectos = JSON.parse(data.fields.proyectos);
      if (!Array.isArray(proyectos)) proyectos = [];
      }
      Logger.log("Proyectos parsed: " + proyectos.length);
    } catch (err) {
      Logger.log("Error parsing proyectos: " + err.message);
      return jsonResponse({ error: "Invalid project format: " + err.message });
    }

    Logger.log("Creating user folder...");
    var userFolder;
    try {
      userFolder = getOrCreateUserFolder(data.fields.email);
      Logger.log("User folder created/retrieved");
    } catch (folderErr) {
      Logger.log("Error with folder: " + folderErr.message);
      Logger.log("Folder error stack: " + (folderErr.stack || "No stack"));
      
      var errorMsg = "Error al crear la carpeta en Drive: " + folderErr.message;
      if (folderErr.message.indexOf("access") !== -1 || folderErr.message.indexOf("permission") !== -1 || folderErr.message.indexOf("Necesitas acceso") !== -1) {
        errorMsg += "\n\n⚠️ El script necesita permisos para acceder a Drive. Por favor, ejecuta la función 'authorizeDrive' en el editor de Apps Script y autoriza los permisos.";
      }
      
      return jsonResponse({ 
        error: errorMsg,
        errorDetails: folderErr.stack || "No hay más detalles disponibles",
        errorType: "FOLDER_ERROR",
        status: "ERROR"
      });
    }

    Logger.log("Uploading files...");
    var fileLinks = {};
    try {
      fileLinks = uploadFiles(data.files || {}, userFolder);
      Logger.log("Files uploaded: " + Object.keys(fileLinks).length);
    } catch (fileErr) {
      Logger.log("Error uploading files: " + fileErr.message);
      // Continuar aunque haya error con archivos
    }

    Logger.log("Saving main row...");
    try {
    saveMainRow(data.fields, fileLinks, userFolder);
      Logger.log("Main row saved");
    } catch (saveErr) {
      Logger.log("Error saving main row: " + saveErr.message);
      Logger.log("Save error stack: " + (saveErr.stack || "No stack"));
      return jsonResponse({ 
        error: "Error al guardar los datos en la hoja de cálculo: " + saveErr.message,
        errorDetails: saveErr.stack || "No hay más detalles disponibles",
        errorType: "SAVE_ERROR",
        status: "ERROR"
      });
    }

    Logger.log("Saving projects...");
    try {
    saveProjects(data.fields.email, proyectos);
      Logger.log("Projects saved");
    } catch (projErr) {
      Logger.log("Error saving projects: " + projErr.message);
      // Continuar aunque haya error con proyectos
    }

    Logger.log("Success!");
    return jsonResponse({
      status: "OK",
      msg: "Formulario recibido correctamente",
      proyectosGuardados: proyectos.length
    });

  } catch (err) {
    var errorMsg = "Error processing request: " + err.message;
    var errorStack = err.stack || "No stack trace available";
    
    // Log detallado del error
    Logger.log("========================================");
    Logger.log("FATAL ERROR ENCOUNTERED");
    Logger.log("========================================");
    Logger.log("Error message: " + errorMsg);
    Logger.log("Error name: " + (err.name || "Unknown"));
    Logger.log("Error toString: " + err.toString());
    Logger.log("Stack trace: " + errorStack);
    
    // Intentar obtener más información del error
    try {
      Logger.log("Error details: " + JSON.stringify(err));
    } catch (e) {
      Logger.log("Could not stringify error: " + e.message);
    }
    
    Logger.log("========================================");
    
    // También mostrar el error en la respuesta para que sea más visible
    var errorResponse = {
      error: errorMsg,
      errorDetails: errorStack.substring(0, 500), // Limitar tamaño
      status: "ERROR",
      timestamp: new Date().toISOString()
    };
    
    Logger.log("Returning error response: " + JSON.stringify(errorResponse));
    
    return jsonResponse(errorResponse);
  }
}

// Función de prueba para diagnosticar problemas
function testConnection() {
  try {
    Logger.log("=== TEST CONNECTION ===");
    
    // Test 1: Verificar acceso a la hoja de cálculo
    Logger.log("Test 1: Checking spreadsheet access...");
    var spreadsheet = SpreadsheetApp.openById(SHEET_ID);
    Logger.log("✓ Spreadsheet accessed successfully");
    
    // Test 2: Verificar hoja "Respuestas"
    Logger.log("Test 2: Checking 'Respuestas' sheet...");
    var respuestasSheet = spreadsheet.getSheetByName("Respuestas");
    if (!respuestasSheet) {
      Logger.log("✗ Sheet 'Respuestas' NOT FOUND");
      return { error: "Sheet 'Respuestas' not found" };
    }
    Logger.log("✓ Sheet 'Respuestas' found");
    
    // Test 3: Verificar hoja "Proyectos"
    Logger.log("Test 3: Checking 'Proyectos' sheet...");
    var proyectosSheet = spreadsheet.getSheetByName("Proyectos");
    if (!proyectosSheet) {
      Logger.log("⚠ Sheet 'Proyectos' not found (optional)");
    } else {
      Logger.log("✓ Sheet 'Proyectos' found");
    }
    
    // Test 4: Verificar acceso a la carpeta
    Logger.log("Test 4: Checking folder access...");
    var parent = DriveApp.getFolderById(FOLDER_PARENT_ID);
    Logger.log("✓ Folder accessed successfully");
    
    Logger.log("=== ALL TESTS PASSED ===");
    return { status: "OK", message: "All tests passed" };
    
  } catch (err) {
    Logger.log("=== TEST FAILED ===");
    Logger.log("Error: " + err.message);
    Logger.log("Stack: " + (err.stack || "No stack"));
    return { error: err.message, stack: err.stack };
  }
}

// Función para ver los últimos logs de error
function viewLastError() {
  try {
    // Intentar leer los logs más recientes
    Logger.log("=== VIEWING LAST ERROR ===");
    Logger.log("Esta función te ayudará a ver qué pasó en la última ejecución");
    Logger.log("Por favor, revisa el 'Registro de ejecución' después de ejecutar esta función");
    
    // Intentar acceder a la hoja para verificar que todo funciona
    var spreadsheet = SpreadsheetApp.openById(SHEET_ID);
    var sheet = spreadsheet.getSheetByName("Respuestas");
    
    Logger.log("✓ Conexión a la hoja verificada");
    Logger.log("Si ves este mensaje, la configuración básica está bien");
    Logger.log("El error probablemente está en el procesamiento de datos del formulario");
    
    return "Revisa el 'Registro de ejecución' para ver estos mensajes";
  } catch (err) {
    Logger.log("ERROR en viewLastError: " + err.message);
    Logger.log("Stack: " + (err.stack || "No stack"));
    return "Error: " + err.message;
  }
}

// Función para autorizar el acceso a Drive
function authorizeDrive() {
  try {
    Logger.log("=== AUTORIZANDO ACCESO A DRIVE ===");
    
    // Intentar acceder a la carpeta - esto forzará la autorización
    Logger.log("Intentando acceder a la carpeta de Drive...");
    var parent = DriveApp.getFolderById(FOLDER_PARENT_ID);
    Logger.log("✓ Acceso a Drive autorizado correctamente");
    Logger.log("Nombre de la carpeta: " + parent.getName());
    
    // Intentar crear una carpeta de prueba
    Logger.log("Creando carpeta de prueba...");
    var testFolder = parent.createFolder("TEST_AUTORIZACION_" + new Date().getTime());
    Logger.log("✓ Carpeta de prueba creada: " + testFolder.getName());
    
    // Eliminar la carpeta de prueba
    testFolder.setTrashed(true);
    Logger.log("✓ Carpeta de prueba eliminada");
    
    Logger.log("=== AUTORIZACIÓN COMPLETA ===");
    return "Autorización exitosa. El script ahora puede acceder a Drive.";
    
  } catch (err) {
    Logger.log("ERROR en authorizeDrive: " + err.message);
    Logger.log("Stack: " + (err.stack || "No stack"));
    
    if (err.message.indexOf("access") !== -1 || err.message.indexOf("permission") !== -1) {
      return "Error: Necesitas autorizar el acceso a Drive. Por favor, ejecuta esta función nuevamente y autoriza los permisos cuando se te solicite.";
    }
    
    return "Error: " + err.message;
  }
}

function validateRequired(fields, required) {
  required.forEach(function(key) {
    if (!fields[key] || fields[key].toString().trim() === "") {
      throw new Error("Missing required field: " + key);
    }
  });
}

function saveMainRow(fields, fileLinks, userFolder) {
  try {
    Logger.log("saveMainRow: Starting to save data...");
    
    var spreadsheet;
    try {
      spreadsheet = SpreadsheetApp.openById(SHEET_ID);
      Logger.log("saveMainRow: Spreadsheet opened successfully");
    } catch (spreadsheetErr) {
      Logger.log("saveMainRow: Error opening spreadsheet: " + spreadsheetErr.message);
      throw new Error("No se pudo acceder a la hoja de cálculo. Verifica que el ID sea correcto y que tengas permisos: " + spreadsheetErr.message);
    }
    
    var sheet = spreadsheet.getSheetByName("Respuestas");
    
    if (!sheet) {
      Logger.log("saveMainRow: Sheet 'Respuestas' not found");
      throw new Error("No se encontró la hoja 'Respuestas'. Por favor, créala en la hoja de cálculo.");
    }
    
    Logger.log("saveMainRow: Sheet found, preparing data...");
    
    var folderUrl = "";
    try {
      if (userFolder) {
        folderUrl = userFolder.getUrl();
      }
    } catch (e) {
      Logger.log("Error getting folder URL: " + e.message);
    }
    
    var rowData = [
      new Date(), 
      fields.email || "", 
      fields.razonSocial || "", 
      fields.nit || "", 
      fields.domicilio || "",
      fields.representante || "", 
      fields.cedulaRep || "", 
      fields.direccionNotificacion || "", 
      fields.telefono || "",
      (fileLinks && fileLinks.certificadoExistencia) || "", 
      (fileLinks && fileLinks.estadosFinancieros) || "",
      (fileLinks && fileLinks.autorizacionSubasta) || "", 
      (fileLinks && fileLinks.sarlaft) || "",
      fields.garantiaMonto || "", 
      fields.instrumentoTipo || "", 
      fields.entidadEmisora || "",
      fields.instrumentoNumero || "", 
      fields.fechaExpedicion || "", 
      fields.vigenciaInstrumento || "",
      fields.acepta || "", 
      fields.firmaNombre || "", 
      fields.firmaFecha || "",
      fields.proyectos || "", 
      folderUrl
    ];
    
    Logger.log("saveMainRow: Attempting to append row with " + rowData.length + " columns");
    
    try {
      sheet.appendRow(rowData);
      Logger.log("saveMainRow: Row appended successfully");
    } catch (appendErr) {
      Logger.log("saveMainRow: Error appending row: " + appendErr.message);
      Logger.log("saveMainRow: Error stack: " + (appendErr.stack || "No stack"));
      throw new Error("Error al guardar la fila en la hoja: " + appendErr.message);
    }
    
  } catch (err) {
    Logger.log("Error in saveMainRow: " + err.message);
    Logger.log("Error stack: " + (err.stack || "No stack"));
    throw err;
  }
}

function saveProjects(email, proyectos) {
  try {
    if (!proyectos || proyectos.length === 0) {
      return; // No hay proyectos para guardar
    }
    
    var spreadsheet = SpreadsheetApp.openById(SHEET_ID);
    var sheet = spreadsheet.getSheetByName("Proyectos");
    
    if (!sheet) {
      Logger.log("Sheet 'Proyectos' not found, skipping project save");
      return;
    }
    
    var rows = proyectos.map(function(p) {
      return [
        new Date(), 
        email || "", 
        (p && p.numero) || "", 
        (p && p.nombre) || "", 
        (p && p.ubicacion) || "",
        (p && p.tamano) || "", 
        (p && p.estado) || ""
      ];
    });
    
    if (rows.length > 0 && rows[0].length > 0) {
    sheet.getRange(sheet.getLastRow() + 1, 1, rows.length, rows[0].length).setValues(rows);
    }
  } catch (err) {
    Logger.log("Error in saveProjects: " + err.message);
    throw err;
  }
}

function uploadFiles(files, folder) {
  var result = {};
  
  if (!files || !folder) {
    Logger.log("No files or folder provided for upload");
    return result;
  }
  
  try {
    Object.keys(files).forEach(function(key) {
      try {
        var file = files[key];
        if (file && file.bytes) {
          var blob = Utilities.newBlob(file.bytes, file.type || "application/octet-stream", file.filename || key);
          var uploaded = folder.createFile(blob);
    result[key] = uploaded.getUrl();
          Logger.log("File uploaded: " + key);
        }
      } catch (fileErr) {
        Logger.log("Error uploading file " + key + ": " + fileErr.message);
        // Continuar con otros archivos
      }
    });
  } catch (err) {
    Logger.log("Error in uploadFiles: " + err.message);
    // Retornar lo que se haya subido hasta ahora
  }
  
  return result;
}

function getOrCreateUserFolder(email) {
  try {
    if (!email || email.trim() === "") {
      throw new Error("Email is required to create folder");
    }
    
    var parent = DriveApp.getFolderById(FOLDER_PARENT_ID);
    var existing = parent.getFoldersByName(email);
    
    if (existing.hasNext()) {
      return existing.next();
    } else {
      return parent.createFolder(email);
    }
  } catch (err) {
    Logger.log("Error in getOrCreateUserFolder: " + err.message);
    throw err;
  }
}

function jsonResponse(obj) {
  // Devolver HTML con JSON embebido para que el iframe pueda leerlo
  var jsonString = JSON.stringify(obj);
  
  // Si hay un error, hacerlo más visible en el HTML
  var errorHtml = '';
  if (obj.error || obj.status === 'ERROR') {
    errorHtml = '<div style="background-color: #ffebee; border: 2px solid #f44336; padding: 20px; margin: 20px; border-radius: 5px; font-family: Arial, sans-serif;">' +
                '<h2 style="color: #c62828; margin-top: 0;">❌ ERROR</h2>' +
                '<p style="color: #d32f2f; font-size: 16px; font-weight: bold;">' + (obj.error || 'Error desconocido') + '</p>';
    
    if (obj.errorDetails) {
      errorHtml += '<details style="margin-top: 15px;">' +
                   '<summary style="cursor: pointer; color: #1976d2; font-weight: bold;">Ver detalles técnicos</summary>' +
                   '<pre style="background-color: #fff; padding: 10px; border: 1px solid #ccc; margin-top: 10px; overflow-x: auto; font-size: 12px;">' + 
                   obj.errorDetails + 
                   '</pre></details>';
    }
    
    if (obj.errorType) {
      errorHtml += '<p style="margin-top: 10px; color: #666; font-size: 14px;"><strong>Tipo de error:</strong> ' + obj.errorType + '</p>';
    }
    
    errorHtml += '</div>';
  } else if (obj.status === 'OK') {
    errorHtml = '<div style="background-color: #e8f5e9; border: 2px solid #4caf50; padding: 20px; margin: 20px; border-radius: 5px; font-family: Arial, sans-serif;">' +
                '<h2 style="color: #2e7d32; margin-top: 0;">✅ ÉXITO</h2>' +
                '<p style="color: #388e3c; font-size: 16px; font-weight: bold;">' + (obj.msg || 'Operación completada correctamente') + '</p>';
    
    if (obj.proyectosGuardados !== undefined) {
      errorHtml += '<p style="margin-top: 10px; color: #666; font-size: 14px;">Proyectos guardados: ' + obj.proyectosGuardados + '</p>';
    }
    
    errorHtml += '</div>';
  }
  
  var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Response</title>' +
             '<style>body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }</style></head>' +
             '<body>' + 
             errorHtml +
             '<div style="margin: 20px; padding: 15px; background-color: white; border: 1px solid #ddd; border-radius: 5px;">' +
             '<h3 style="margin-top: 0;">Datos de respuesta (JSON):</h3>' +
             '<pre id="response" style="background-color: #f9f9f9; padding: 10px; border: 1px solid #ddd; overflow-x: auto;">' + 
             jsonString + 
             '</pre></div>' +
             '<script>window.responseData = ' + 
             jsonString + 
             ';try{if(window.parent!==window){window.parent.postMessage(' + 
             jsonString + 
             ',\'*\');}}catch(e){console.log("Error sending message:",e);}}</script></body></html>';
  
  var output = ContentService.createTextOutput(html);
  try {
    output.setMimeType(ContentService.MimeType.HTML);
  } catch (e) {
    Logger.log("Error setting MIME type: " + e.message);
  }
  
  // Intentar establecer headers - si falla, continuar sin ellos
  try {
    output.setHeader('Access-Control-Allow-Origin', '*');
    output.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
    output.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  } catch (e) {
    Logger.log("Error setting headers (puede ser normal en algunas versiones): " + e.message);
    // Continuar sin headers - el iframe debería funcionar de todas formas
  }
  
  return output;
}